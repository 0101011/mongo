#! /bin/sh

# It was a pain updating all the copyrights in the Berkeley DB tree: I'm not
# doing that again, the only files carrying copyrights in the WiredTiger tree
# are the source files, that is, *.[ch] and *.in.  Check automatically to be
# sure the copyright is up-to-date.

c1=__wt.1$$
c2=__wt.2$$
c3=__wt.3$$
trap 'rm -f c1 c2 c3; exit 0' 0 1 2 3 13 15

year=`date +%Y`

cat > $c1 <<ENDOFTEXT
/*-
 * Copyright (c) 2008-$year WiredTiger, Inc.
 *	All rights reserved.
 *
 * See the file LICENSE for redistribution information.
ENDOFTEXT

# Copyright for files WiredTiger does not own.
cat > $c2 <<ENDOFTEXT
/*-
 * Copyright (c) 2008-$year WiredTiger, Inc.
 *
 * This is free and unencumbered software released into the public domain.
ENDOFTEXT

cat > $c3 <<ENDOFTEXT
#!/usr/bin/env python
#
# Copyright (c) 2008-$year WiredTiger, Inc.
#	All rights reserved.
#
# See the file LICENSE for redistribution information.
ENDOFTEXT

check()
{
	# Skip auto-generated files, files in which WiredTiger holds no rights.
	if `egrep "skip	$1" s_copyright.list > /dev/null`; then
		return;
	fi

	# Check for a correct copyright header.
	if `sed -e 5q ../$1 | diff - $c1 > /dev/null` ; then
		return;
	fi
	if `sed -e 4q ../$1 | diff - $c2 > /dev/null` ; then
		return;
	fi
	if `sed -e 6q ../$1 | diff - $c3 > /dev/null` ; then
		return;
	fi

	echo "$1: copyright information is incorrect"
}

l="`cd .. && \
    echo examples/c/*.c \
	 src/include/*.[hi] \
	 src/include/*.in \
	 src/utilities/*.c \
	 test/suite/*.py`"

l="$l `sed -e 's/^add	\(.*\)/\1/p' -e d s_copyright.list`"
for i in $l `sed -e '/^[a-z]/! d' filelist`; do
	check $i
done

# The documentation copyright appears in two files.
s="Copyright (c) 2008-$year WiredTiger, Inc.  All rights reserved."
f="../docs/build-javadoc.sh ../docs/style/footer.html"
for i in $f; do
	if `grep "$s" $i > /dev/null`; then
		continue;
	fi
	echo "$i: copyright information is incorrect"
done
